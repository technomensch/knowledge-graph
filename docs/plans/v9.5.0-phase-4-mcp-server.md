# v9.5.0 Phase 4: MCP Server

**Session:** 2 or 3 — Claude Code
**Goal:** Build MCP server as the data layer for deterministic operations.
**Deliverable:** Working MCP server that skills can call and non-Claude users can use standalone.
**Depends on:** Phase 1 (need plugin structure + skill data operation patterns)
**Runs in parallel with:** Phase 3 (Antigravity). Can overlap with Phase 2 in same Claude Code session.
**Reference:** See `v9.5.0-master-plan.md` for config schema, skill-to-MCP mapping, and architecture.

---

## Pre-flight

- [ ] Phase 1 complete (plugin structure exists, skills define data operations)
- [ ] Node.js available: `node --version`
- [ ] npm available: `npm --version`

---

## 4.1: Scaffold MCP server

**Recommendation: TypeScript** — most common MCP language, better type safety, wider ecosystem.

```bash
cd /Users/mkaplan/Documents/GitHub/knowledge-graph-plugin/mcp-server
npm init -y
npm install @modelcontextprotocol/sdk zod
npm install -D typescript @types/node
npx tsc --init
```

Create directory structure:
```bash
mkdir -p src/{tools,resources}
```

Create `src/index.ts` — MCP server entry point that registers all tools and resources.

---

## 4.2: Implement MCP tools (7 core tools)

| MCP Tool | Maps to Skill | What it does | Input Schema |
|----------|---------------|-------------|-------------|
| `kg_config_init` | init | Create KG dir structure + write config entry | `{ name, path, type, categories[], gitStrategy }` |
| `kg_config_list` | list | Read and return all KGs from config | `{}` (no input) |
| `kg_config_switch` | switch | Update active KG in config | `{ name }` |
| `kg_config_add_category` | add-category | Add category dir + update config | `{ name, prefix?, gitStrategy }` |
| `kg_search` | recall | Full-text search across KG files | `{ query, format?: "summary"|"paths"|"detailed" }` |
| `kg_scaffold` | capture-lesson, meta-issue | Create file from template with variable substitution | `{ template, variables, outputPath }` |
| `kg_check_sensitive` | check-sensitive | Scan files against regex patterns | `{ path?, patterns?: string[] }` |

### Implementation details per tool:

**`kg_config_init`:**
- Read `~/.claude/kg-config.json` (create if missing)
- Validate name doesn't already exist
- Create directory structure at specified path
- Write config entry with categories and git strategy
- Set as active
- Return created config entry

**`kg_config_list`:**
- Read `~/.claude/kg-config.json`
- Return array of all graphs with metadata
- Mark active graph

**`kg_config_switch`:**
- Read config, find graph by name
- Update "active" field
- Write config
- Return new active graph info

**`kg_config_add_category`:**
- Read config for active graph
- Create `lessons-learned/{category}/` dir
- Create `knowledge/{category}.md` if needed
- Update config with new category
- Update `.gitignore` if git strategy is "ignore"

**`kg_search`:**
- Get active KG path from config
- Walk directory tree: `knowledge/`, `lessons-learned/`, `decisions/`, `sessions/`
- Read MEMORY.md if it exists
- Full-text search (case-insensitive)
- Rank by relevance (title match > heading match > body match)
- Return results in requested format

**`kg_scaffold`:**
- Read template from `core/templates/{template}`
- Substitute variables (title, date, author, category, git metadata)
- Write to output path
- Return created file path

**`kg_check_sensitive`:**
- Get active KG path (or use provided path)
- Walk all markdown files
- Apply regex patterns: emails, API keys, URLs, custom patterns from config
- Return structured report: `{ violations: [{ file, line, type, match }] }`

### Optional tools (if time permits):

| MCP Tool | Maps to Skill | What it does |
|----------|---------------|-------------|
| `kg_git_metadata` | capture-lesson | Run git commands, return `{ branch, commit, author, pr?, issue? }` |
| `kg_link_issue` | link-issue | Update YAML frontmatter + post GitHub comment via `gh` |
| `kg_extract_chat` | extract-chat | Run Python extraction scripts, return results |

---

## 4.3: Implement MCP resources (2 resources)

| Resource URI | What it exposes |
|-------------|----------------|
| `kg://config` | Current `~/.claude/kg-config.json` contents (read-only) |
| `kg://templates/{name}` | Template files from `core/templates/` (e.g., `kg://templates/lessons-learned/lesson-template.md`) |

---

## 4.4: Wire MCP server into plugin

Update `.claude-plugin/plugin.json` to reference MCP server:
```json
{
  "mcp_servers": {
    "knowledge": {
      "command": "node",
      "args": ["${CLAUDE_PLUGIN_ROOT}/mcp-server/dist/index.js"]
    }
  }
}
```

Update skills to call MCP tools where appropriate (skills become thinner orchestration):
- `capture-lesson` calls `kg_scaffold` + `kg_git_metadata` then does LLM reasoning for content
- `recall` calls `kg_search` then formats output with suggestions
- `check-sensitive` calls `kg_check_sensitive` then presents findings
- `init` calls `kg_config_init` after wizard prompts collect user preferences

---

## 4.5: MCP build automation

Add a `postinstall` script to `mcp-server/package.json` so the MCP server builds automatically:
```json
{
  "scripts": {
    "build": "tsc",
    "postinstall": "npm run build"
  }
}
```
Also create `scripts/prepare-mcp.sh` that checks for Node.js, runs `npm install`, and verifies the build.

## 4.6: Build and test standalone

```bash
cd mcp-server
npm run build

# Test with MCP inspector
npx @modelcontextprotocol/inspector node dist/index.js
```

**Test each tool:**
1. `kg_config_init` — create a test KG
2. `kg_config_list` — verify it appears
3. `kg_config_switch` — switch between KGs
4. `kg_search` — search for known content
5. `kg_scaffold` — create a file from template
6. `kg_check_sensitive` — scan test files

---

## Exit Criteria

- [ ] MCP server builds without errors: `npm run build`
- [ ] All 7 core tools return correct results
- [ ] Resources serve config and templates
- [ ] Plugin manifest updated to reference MCP server
- [ ] MCP inspector shows all tools and resources
- [ ] Skills that delegate to MCP tools still work end-to-end
- [ ] MCP server works standalone (not just through plugin)
