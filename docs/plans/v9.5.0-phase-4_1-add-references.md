# Phase 4.1: Add Web Search Reference Tracking to Knowledge Graph

**Version:** v9.5.0-phase-4.1
**Status:** Planning
**Dependencies:** Phase 1 (templates), Phase 2 (skills)

---

## Context

**Problem:** When creating lessons learned or knowledge graph entries, insights often come from web searches (via the WebSearch tool). Currently, the plugin does NOT track the source URLs where information was found. This means:
- No attribution to external sources
- Can't verify claims later by re-reading the source
- Lose valuable reference material that helped solve the problem
- Citation/attribution best practice not followed

**Prompted by:** User question: "If the solution or finding is from a search online, does the knowledge graph add the location the results were found as reference material?"

**Current state:**
- Git metadata (branch, commit, PR, issue) IS tracked in YAML frontmatter
- Lesson → KG source attribution exists: `**Source:** Lesson Name (Branch: v2.3, PR: #45)`
- Web search sources are NOT tracked anywhere

**Intended outcome:** Add support for capturing and displaying web search sources in both lessons learned and knowledge graph entries, with bidirectional linking and proper attribution.

---

## Implementation Plan

### Phase 1: Update Templates (Add `sources` field)

**Files to modify:**

1. **`core/templates/lessons-learned/lesson-template.md`**
   - Add `sources` array to YAML frontmatter
   - Add "External References" section before "Related Documentation"

2. **`core/templates/knowledge/entry-template.md`**
   - Add "External References" section with URL list format
   - Include guidance on when to use this vs. lesson links

**New frontmatter structure:**
```yaml
---
title: "Lesson: [Title]"
created: YYYY-MM-DDTHH:MM:SSZ
author: [Your Name]
email: [Your Email]
git:
  branch: [branch-name]
  commit: [commit-hash]
  pr: [pr-number or null]
  issue: [issue-number or null]
sources:  # ← NEW FIELD
  - url: "https://example.com/article"
    title: "Article Title"
    accessed: "YYYY-MM-DD"
    context: "Used for [specific insight]"
tags: []
category: [architecture|process|patterns|debugging]
---
```

**New lesson section (before "Related Documentation"):**
```markdown
## External References

Sources consulted while solving this problem:

- **[Article Title](https://example.com/article)** — Accessed: YYYY-MM-DD
  - Context: Used for understanding [specific concept]
  - Key insight: [What we learned from this source]

- **[Documentation Page](https://docs.example.com/page)** — Accessed: YYYY-MM-DD
  - Context: Referenced for [specific implementation detail]
  - Key insight: [What we learned from this source]
```

**New KG entry section (in entry-template.md):**
```markdown
**External References:**
- [Source Title](URL) — [Brief context of what was learned]
- [Source Title](URL) — [Brief context of what was learned]
```

---

### Phase 2: Update Skills to Prompt for Sources

**Files to modify:**

1. **`skills/capture-lesson/SKILL.md`**
   - Add Step 1.7: "Capture External Sources (Optional)"
   - Prompt: "Were any web searches or external resources consulted? If yes, provide URLs."
   - Auto-populate `sources` array in YAML frontmatter
   - Generate "External References" section in lesson body

2. **`skills/update-graph/SKILL.md`**
   - Update Step 2: "Extract Key Elements" — add sources extraction
   - Update Step 4: "Create or Update Knowledge Entry" — include external references in KG entry format
   - Preserve source URLs when extracting lesson → KG

**Capture-lesson changes (Step 1.7):**
```markdown
### Step 1.7: Capture External Sources (Optional)

**Prompt user:**
"Were any web searches or external documentation consulted while solving this problem?

If yes, please provide:
1. URL
2. Title (or auto-fetch from URL)
3. What you learned from this source

[Enter URLs one per line, or type 'skip' to continue without sources]"

**For each URL provided:**
1. Auto-fetch page title (if accessible via WebFetch tool)
2. Record access date (today's date)
3. Prompt for context: "What did you learn from [URL]?"
4. Add to `sources` array in frontmatter
5. Generate entry for "External References" section
```

**Update-graph changes (Step 2 & 4):**
```markdown
### Step 2: Extract Key Elements

[... existing elements 1-7 ...]

8. **External Sources** (from YAML frontmatter)
   ```yaml
   sources:
     - url: "https://..."
       title: "..."
       context: "..."
   ```
   └─ Preserve for **External References:** section in KG entry

### Step 4: Create or Update Knowledge Entry

[... existing format ...]

**External References:** (if sources exist in lesson)
- [Source Title](URL) — Context: [Brief note]
- [Source Title](URL) — Context: [Brief note]

**Source:** [Lesson title] (Branch: {branch}, PR: #{pr})
**See:** [Link to full lesson]
**Related:** [Link to related patterns/ADRs]
```

---

### Phase 3: MCP Server Support (Optional Enhancement)

**If time permits, add MCP tool for URL metadata fetching:**

**New file:** `mcp-server/src/tools/sources.ts`
```typescript
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { z } from "zod";

export function registerSourcesTool(server: McpServer): void {
  server.tool(
    "kg_fetch_url_metadata",
    "Fetch title and metadata from a URL for source attribution",
    {
      url: z.string().describe("URL to fetch metadata from"),
    },
    async ({ url }) => {
      // Fetch page via HTTP
      // Extract <title>, <meta name="description">, etc.
      // Return structured metadata

      // Implementation uses node-fetch or similar
      // Parse HTML with cheerio or similar
      // Return: { title, description, domain }
    }
  );
}
```

**Register in:** `mcp-server/src/index.ts`
```typescript
import { registerSourcesTool } from "./tools/sources.js";

// In main():
registerSourcesTool(server); // kg_fetch_url_metadata
```

**Benefits:**
- Auto-populate source title from `<title>` tag
- Auto-populate description from meta tags
- Validate URL is accessible before saving

---

## Critical Files

### Templates
- `core/templates/lessons-learned/lesson-template.md` — Add `sources` frontmatter + External References section
- `core/templates/knowledge/entry-template.md` — Add External References format

### Skills
- `skills/capture-lesson/SKILL.md` — Add Step 1.7 for source capture
- `skills/update-graph/SKILL.md` — Extract and preserve sources when lesson → KG

### MCP (Optional)
- `mcp-server/src/tools/sources.ts` — New tool for URL metadata fetching
- `mcp-server/src/index.ts` — Register kg_fetch_url_metadata

---

## Verification Steps

After implementing:

1. **Create test lesson with web sources:**
   ```bash
   /knowledge:capture-lesson
   # When prompted for sources, provide 2-3 URLs
   ```

2. **Verify frontmatter populated:**
   ```bash
   # Check that sources array exists in YAML
   grep -A 10 "^sources:" {lesson-file}
   ```

3. **Verify External References section created:**
   ```bash
   # Check that section exists with formatted links
   grep -A 5 "## External References" {lesson-file}
   ```

4. **Extract to KG:**
   ```bash
   /knowledge:update-graph --lesson={test-lesson}
   ```

5. **Verify KG entry includes external refs:**
   ```bash
   # Check that KG entry has External References section
   grep -B 2 -A 3 "External References:" {kg-file}
   ```

6. **Verify bidirectional linking:**
   - Lesson has URLs in "External References"
   - KG entry references those same URLs
   - All links are clickable and valid

7. **Test MCP tool (if implemented):**
   ```bash
   # Call kg_fetch_url_metadata with test URL
   # Verify title extraction works
   ```

---

## Design Decisions

### Why `sources` in YAML vs. just markdown section?
- **Machine-readable** — can be parsed by MCP tools or scripts
- **Structured data** — consistent format for automation
- **Preservable** — when extracting lesson → KG, sources travel with the data
- **Queryable** — future feature could search by source domain

### Why "External References" separate from "Related Documentation"?
- **Clear distinction**: External = web/public docs, Related = internal project docs
- **Attribution best practice**: Makes it clear when ideas came from outside sources
- **Verification**: Easy to re-check external sources later

### Optional vs. Required?
- **Optional** — not every lesson needs external sources (some are pure debugging/experimentation)
- **Prompted** — skill asks, but user can skip
- **Encouraged** — template includes the section to remind users it's available

### URL Title Fetching Strategy
- **Use WebFetch tool** (already available in Claude Code) for basic fetching
- **Optional MCP tool** provides more robust parsing and metadata extraction
- **Fallback**: User provides title manually if auto-fetch fails

---

## Future Enhancements (Out of Scope for v1.0)

1. **Auto-archive web sources** — Download snapshots via Wayback Machine API
2. **Citation style options** — APA, MLA, Chicago formats
3. **Source quality scoring** — Flag low-quality sources (Stack Overflow answers with 0 upvotes, etc.)
4. **Duplicate detection** — "This URL is already referenced in 3 other lessons"
5. **DOI/ISBN support** — Academic papers and books

---

## Testing Checklist

- [ ] Template updates preserve existing structure
- [ ] YAML sources array parses correctly
- [ ] External References section renders properly
- [ ] capture-lesson skill prompts for sources
- [ ] Skipping sources doesn't break workflow
- [ ] update-graph preserves sources when extracting
- [ ] KG entries display external refs correctly
- [ ] Bidirectional links work (lesson ↔ KG)
- [ ] MCP tool fetches URL metadata (if implemented)
- [ ] No breaking changes to existing lessons

---

## Exit Criteria

**Phase 4.1 is complete when:**
- [x] Both templates updated with `sources` field and External References section
- [x] capture-lesson skill prompts for and captures web sources
- [x] update-graph skill preserves and displays sources in KG entries
- [x] End-to-end test: create lesson with sources → extract to KG → verify both display correctly
- [x] (Optional) MCP tool implemented and tested for URL metadata fetching
- [x] Documentation updated to explain new source tracking feature

---

**Created:** 2026-02-13
**Author:** Phase 4.1 planning session
**Related Plans:** v9.5.0-phase-1-foundation.md, v9.5.0-phase-2-new-skills.md
