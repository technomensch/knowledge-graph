# v0.0.3-alpha Plan: Automation & Memory Management

## Context

**Problem:** After capturing lessons with `/knowledge:capture-lesson`, users must manually remember to run `/knowledge:update-graph` and `/knowledge:sync-all`. The workflow file from optimize-my-resume has tighter KG coupling (inline updates), but the plugin's delegated architecture is correct for multi-KG support.

**Solution:** Enhance the existing delegated architecture with automation (hybrid skill guidance + command hooks) rather than porting inline updates. Also add MEMORY.md bloat prevention.

**Previous version:** 0.0.2-alpha
**Branch:** `v0.0.3-alpha`

---

## Architectural Decision: Delegated > Inline

The plugin's delegated architecture (commands delegate to `/knowledge:update-graph`) is superior to inline updates because:
- Multi-KG config requires centralized path resolution (4 path types)
- Single active pointer pattern needs single authority for state
- Platform portability requires Core + Automation layer separation
- 16 commands + 7 MCP tools benefit from centralized patterns

**Decision:** Preserve delegation. Automate it instead.

---

## Phase 1: Skill Enhancement + Command Hooks

### 1. Enhance `skills/knowledge-graph-usage/SKILL.md`

**Current size:** ~1,672 words (SKILL.md body) + ~12,000 words (references/)

**Add three autonomous triggering sections (~500 words total ‚Üí ~2,172 words):**

- **After lesson capture:** Suggest `/knowledge:update-graph` immediately
- **After significant commits:** Detect fix/debug/pattern keywords, suggest capture
- **Before problem-solving:** Suggest `/knowledge:recall` to check existing knowledge

**Update frontmatter description** to include new trigger contexts.

### 2. Modify `commands/capture-lesson.md` ‚Äî Step 4.6

**Current:** Recommends user run commands manually
**New:** Present structured choice with recommended default

```markdown
### Step 4.6: Update Knowledge Graph

"Lesson captured! Extract insights to Knowledge Graph?"

Options:
1. ‚úÖ Extract now (recommended) ‚Äî Runs /knowledge:update-graph for this lesson
2. Manual later ‚Äî Run /knowledge:update-graph when ready
3. Skip ‚Äî Update KG later via /knowledge:sync-all

If option 1: Execute update-graph workflow inline, include KG files in same commit.
```

**Note:** This embeds guidance text directly in command markdown. Commands cannot dynamically "load" skills ‚Äî the text must be in the command file itself.

### 3. Modify `commands/update-graph.md` ‚Äî Behavioral Changes

**Existing flags** (already in file): `--lesson`, `--auto`
**New flag:** `--edit-entry` ‚Äî Opens generated KG entry for user review/edit before saving

**Behavioral change for `--auto`:** Return structured quality feedback when called from capture-lesson workflow (not just silent execution).

### 4. Create `core/examples-hooks/post-commit-lesson-suggestion` (NEW)

Post-commit hook template with keyword detection:

```bash
#!/bin/bash
commit_msg=$(git log -1 --pretty=%B)
if echo "$commit_msg" | grep -qiE "(fix|solved|debug|implement|refactor|pattern|architecture)"; then
  echo ""
  echo "üí° Lesson-worthy commit detected: $(git log -1 --pretty=%h) - ${commit_msg:0:60}"
  echo "   Capture lesson? /knowledge:capture-lesson"
  echo ""
fi
```

### 5. Modify `commands/init.md` ‚Äî Hook Installation

Add wizard step: "Install post-commit hook for lesson suggestions? [y/N]"
- **Default: No** (opt-in for alpha; consider default-on for v1.0.0)
- Copy template from `core/examples-hooks/`
- Make executable (`chmod +x`)

---

## Phase 2: Context Enhancement + Duplicate Detection

### 6. Modify `hooks/hooks.json` ‚Äî SessionStart Enhancement

Add `recent-lessons.sh` to SessionStart hooks array (alongside existing `check-memory.sh`).

### 7. Create `scripts/recent-lessons.sh` (NEW)

**Location:** `scripts/` directory (matches existing `check-memory.sh` pattern)

- Read active KG path from `~/.claude/kg-config.json` (reuse same grep pattern from `check-memory.sh`)
- Find lessons modified in last 7 days
- Display titles + suggest `/knowledge:recall`

### 8. Modify `skills/knowledge-graph-usage/SKILL.md` ‚Äî Duplicate Detection

Add guidance section (~150 words): "Before capturing, search for similar lessons. Suggest merge if found."

### 9. Modify `commands/capture-lesson.md` ‚Äî Step 1.1 Pre-Flight

Add duplicate detection before content gathering:
- Extract keywords from user's topic
- Search via `kg_search` MCP tool
- If similar found: offer merge (redirect to Step 0) or create new with "Related:" link

---

## Phase 3: MEMORY.md Bloat Prevention

### Size Metric: Token-Based (Not Line-Based)

**Why:** Short lines (5-10 words) vs long lines (30+ words) have very different token costs. Line counting is misleading.

**Limits (token-based, all references consistent):**
- **Soft limit: 1,500 tokens** (~1,100 words) ‚Äî warning
- **Hard limit: 2,000 tokens** (~1,500 words) ‚Äî block/suggest archive

**Token estimation:** `word_count √ó 1.3` (approximate)

**Note:** The existing `update-graph.md` references 250-300 line limits in Step 7. These must be updated to token-based limits for consistency.

### 10. Modify `commands/sync-all.md` ‚Äî Size Check

Add token-based MEMORY.md size check before sync operations.

**Important:** Hook scripts cannot use interactive `read -p` prompts or call slash commands. The size check should OUTPUT warnings/suggestions that Claude reads and acts on, not try to prompt the user directly from bash.

```bash
#!/bin/bash
memory_path=~/.claude/projects/$(basename $(pwd))/memory/MEMORY.md
if [ -f "$memory_path" ]; then
  memory_words=$(wc -w < "$memory_path")
  memory_tokens=$((memory_words * 13 / 10))
  if [ "$memory_tokens" -gt 1500 ]; then
    echo "‚ö†Ô∏è  MEMORY.md approaching limit: ~${memory_tokens}/2000 tokens"
    echo "   Consider: /knowledge:archive-memory"
  fi
  if [ "$memory_tokens" -gt 2000 ]; then
    echo "üõë MEMORY.md exceeds limit: ~${memory_tokens}/2000 tokens"
    echo "   Run: /knowledge:archive-memory before adding new entries"
  fi
fi
```

### 11. Modify `commands/update-graph.md` ‚Äî Step 7 Size Check

Add same token-based check before MEMORY.md sync (Step 7). Replace existing line-based references (250/300 lines) with token-based limits (1,500/2,000 tokens).

### 12. Create `commands/archive-memory.md` (NEW)

New command: `/knowledge:archive-memory`

**Workflow:**
1. Read MEMORY.md, calculate token size
2. Identify stale entries (not referenced in 90 days, dated > 6 months)
3. Move to `MEMORY-archive.md` (same directory as MEMORY.md)
4. Show notification: what was archived, tokens freed, current size
5. User confirms before write
6. Commit both files

**User notification (after archive):**
```
üì¶ MEMORY.md Archived
   Moved: 8 entries (~340 tokens freed)
   Remaining: 47 entries (~1,180 tokens)
   Archive: memory/MEMORY-archive.md
```

### 13. Create `scripts/memory-diff-check.sh` (NEW)

SessionStart hook script to notify user of MEMORY.md changes since last session:
```
üìù MEMORY.md changes (since last session):
   + 2 new entries (Authentication, Git Safety)
   - 1 archived (Old Docker pattern)
```

### 14. Modify `hooks/hooks.json` ‚Äî Add Memory Diff Check

Add `memory-diff-check.sh` to SessionStart hooks array.

---

## Deferred to v0.0.4-alpha

The following features are **out of scope** for v0.0.3-alpha:

- **MEMORY.md auto-sync rules engine** (YAML rules, confidence scoring, pattern matching)
- **Smart summarization** (LLM-powered entry consolidation)
- **`/knowledge:restore-memory` command** (restore archived entries by ID)
- **`config/memory-sync-rules.yaml`** template and per-KG config directories

These require their own design phase and user feedback from v0.0.3 usage.

---

## Files Summary

**Modified (8 files):**
1. `skills/knowledge-graph-usage/SKILL.md` ‚Äî Autonomous triggering + duplicate detection guidance
2. `commands/capture-lesson.md` ‚Äî Step 4.6 choice + Step 1.1 duplicate pre-flight
3. `commands/update-graph.md` ‚Äî `--edit-entry` flag + token-based Step 7 limits
4. `commands/sync-all.md` ‚Äî Token-based MEMORY.md size check
5. `commands/init.md` ‚Äî Post-commit hook installation wizard step
6. `hooks/hooks.json` ‚Äî Add recent-lessons + memory-diff-check to SessionStart
7. `README.md` ‚Äî Update command count (16 ‚Üí 17), add archive-memory
8. `ROADMAP.md` / `CHANGELOG.md` ‚Äî Add v0.0.3-alpha entry

**New (4 files):**
9. `core/examples-hooks/post-commit-lesson-suggestion` ‚Äî Git hook template
10. `scripts/recent-lessons.sh` ‚Äî SessionStart recent lessons display
11. `scripts/memory-diff-check.sh` ‚Äî SessionStart memory change notification
12. `commands/archive-memory.md` ‚Äî Archive stale MEMORY.md entries

**Total: 12 files** (8 modified, 4 new)

---

## Verification Plan

### Phase 1 Testing
- [x] Capture lesson ‚Üí Step 4.6 shows choice (extract now / later / skip)
- [x] Select "Extract now" ‚Üí update-graph runs inline
- [x] Single commit includes lesson + KG files
- [x] Post-commit hook template exists and is executable
- [x] `/knowledge:init` offers hook installation (default: no)

### Phase 2 Testing
- [x] SessionStart shows recent lessons (last 7 days)
- [x] Recent lessons scoped to active KG
- [x] Capture-lesson with existing topic ‚Üí duplicate detection fires
- [x] Merge option redirects to update existing (Step 0)

### Phase 3 Testing
- [x] `/knowledge:archive-memory` archives stale entries
- [x] Notifications show what was added/removed with token counts
- [x] sync-all warns at 1,500 tokens, blocks at 2,000 tokens
- [x] update-graph Step 7 uses token-based limits (not line-based)
- [x] SessionStart shows MEMORY.md changes since last session

### Version Bumps
- [x] `plugin.json` version ‚Üí `0.0.3-alpha`
- [x] `README.md` version ‚Üí `0.0.3-alpha`
- [x] `ROADMAP.md` has v0.0.3-alpha entry
- [x] `CHANGELOG.md` has v0.0.3-alpha entry
- [x] Command count updated (16 ‚Üí 17)
