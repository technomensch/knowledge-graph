# Phase 4.5: Local Environment Preparation & Plugin Integration Test

**Session:** Pre-publish — Claude Code
**Goal:** Back up the old system, prepare the environment, install the plugin, and verify it works with the existing ~5MB knowledge base.
**Deliverable:** Plugin working in optimize-my-resume with existing knowledge content.
**Depends on:** Phases 1-4 complete, Phase 5.1-5.5 complete.
**Reference:** See `v9.5.0-master-plan.md` for verification criteria, scope exclusions, and "Things You Might Have Forgotten."

---

## Context

The knowledge-graph-plugin (16 skills, 7 MCP tools, 2 resources) has passed Phase 5.1-5.5 validation (sanitization, structure, core/ accessibility, end-to-end testing). Before publishing to GitHub (Phase 5.7), we need to test it against the real production environment: the optimize-my-resume project that the plugin was originally extracted from.

**Problem:** optimize-my-resume currently has its own knowledge graph system — skills in `.agent/workflows/know-*.md`, hooks in `.claude/hooks/`, memory in `~/.claude/projects/.../memory/MEMORY.md`, and knowledge files in `docs/knowledge/`. Installing the plugin creates conflicts with these existing components.

**Goal:** Back up the old system, prepare the environment, install the plugin, and verify it works with the existing ~5MB knowledge base. This also serves as the real-world test of the "Integration with Existing Projects" workflow documented in the plugin's `docs/SETUP.md`.

**Rollback guarantee:** Every step has a corresponding undo. A single `rollback.sh` script restores the entire previous state.

---

## Full Inventory: What Gets Backed Up vs. What Stays

### BACK UP & REMOVE (plugin replaces these)

| Component | Location | Size | Why |
|-----------|----------|------|-----|
| `know-capture-lesson.md` | `.agent/workflows/` | 12K | Replaced by `/knowledge:capture-lesson` |
| `know-recall.md` | `.agent/workflows/` | 8K | Replaced by `/knowledge:recall` |
| `know-sync-all.md` | `.agent/workflows/` | 6K | Replaced by `/knowledge:sync-all` |
| `know-update-graph.md` | `.agent/workflows/` | 21K | Replaced by `/knowledge:update-graph` |
| `know-update-issue-plan.md` | `.agent/workflows/` | 10K | Replaced by `/knowledge:update-issue-plan` |
| `doc-session-summary.md` | `.agent/workflows/` | 13K | Replaced by `/knowledge:session-summary` |
| `.claude/skills` symlink | `.claude/skills → ../.agent/workflows` | symlink | Plugin provides its own skills; symlink causes naming collision |
| Project MEMORY.md | `~/.claude/projects/-Users-mkaplan-Documents-GitHub-optimize-my-resume/memory/MEMORY.md` | 11K | Will be updated with new skill names |

### BACK UP & MODIFY (keep but change)

| Component | Location | Size | Change |
|-----------|----------|------|--------|
| `.claude/settings.json` | Project `.claude/` | 721B | Add plugin's SessionStart hook alongside existing governance hooks |
| `.claude/settings.local.json` | Project `.claude/` | 25K | May need new permission entries for plugin skills |

### KEEP IN PLACE (not affected by plugin)

| Component | Location | Why |
|-----------|----------|-----|
| `gov-*.md` (6 files) | `.agent/workflows/` | Plugin does NOT replace governance skills |
| `plan-*.md` (2 files) | `.agent/workflows/` | Plugin does NOT replace planning skills |
| `proj-*.md` (7 files) | `.agent/workflows/` | Plugin does NOT replace project-specific skills |
| `doc-update.md` | `.agent/workflows/` | Plugin does NOT replace doc-update |
| `doc-handoff-backup.md` | `.agent/workflows/` | Plugin does NOT replace handoff-backup |
| `.claude/hooks/*.sh` (3 files) | `.claude/hooks/` | Governance hooks coexist with plugin's SessionStart hook |
| `docs/knowledge/` (10 files, ~100K) | `docs/` | Existing KG content — plugin will manage this |
| `docs/lessons-learned/` (~40 files, ~280K) | `docs/` | Existing content — plugin will manage this |
| `docs/decisions/` (16 ADRs, ~80K) | `docs/` | Existing content — plugin will manage this |
| `docs/issues/` (50+ files, ~2MB) | `docs/` | Existing case studies |
| `docs/sessions/` (30+ files, ~2.5MB) | `docs/` | Existing work logs (gitignored) |
| `docs/plans/` | `docs/` | Active plans |
| `optimization-tools/` (21 files) | root | Shadow Sync Tier 1 — not KG-related |
| `PROJECT-INSTRUCTIONS.md` (183K) | root | Shadow Sync Tier 2 — not KG-related |
| `Project-GUI-Instructions.md` (25K) | root | Shadow Sync Tier 3 — not KG-related |
| Global `~/.claude/settings.json` | home dir | Plugin registry — add plugin entry |
| Global `~/.claude/skills/*.md` (29 files) | home dir | Global skills (n8n, etc.) — unrelated |

---

## Execution Plan

### 4.5.1: Create backup archive

```bash
PROJECT="/Users/mkaplan/Documents/GitHub/optimize-my-resume"
BACKUP_DIR="$PROJECT/.local-archive/pre-plugin-backup-$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"/{claude-config,agent-workflows,claude-hooks,memory}
```

**Back up project-level Claude config:**
```bash
cp "$PROJECT/.claude/settings.json" "$BACKUP_DIR/claude-config/"
cp "$PROJECT/.claude/settings.local.json" "$BACKUP_DIR/claude-config/"
```

**Back up hooks:**
```bash
cp -r "$PROJECT/.claude/hooks/" "$BACKUP_DIR/claude-hooks/"
```

**Back up knowledge-related workflows (6 files):**
```bash
cp "$PROJECT/.agent/workflows/know-capture-lesson.md" "$BACKUP_DIR/agent-workflows/"
cp "$PROJECT/.agent/workflows/know-recall.md" "$BACKUP_DIR/agent-workflows/"
cp "$PROJECT/.agent/workflows/know-sync-all.md" "$BACKUP_DIR/agent-workflows/"
cp "$PROJECT/.agent/workflows/know-update-graph.md" "$BACKUP_DIR/agent-workflows/"
cp "$PROJECT/.agent/workflows/know-update-issue-plan.md" "$BACKUP_DIR/agent-workflows/"
cp "$PROJECT/.agent/workflows/doc-session-summary.md" "$BACKUP_DIR/agent-workflows/"
```

**Back up project memory:**
```bash
cp ~/.claude/projects/-Users-mkaplan-Documents-GitHub-optimize-my-resume/memory/MEMORY.md \
   "$BACKUP_DIR/memory/MEMORY.md"
```

**Record symlink target for rollback:**
```bash
readlink .claude/skills > "$BACKUP_DIR/skills-symlink-target.txt"
```

**Verify backup completeness:**
```bash
find "$BACKUP_DIR" -type f | sort
# Expected: 11 files (2 config + 3 hooks + 6 workflows + 1 memory + 1 symlink-target)
du -sh "$BACKUP_DIR"
# Expected: ~120K
```

---

### 4.5.2: Create rollback script

Write `$BACKUP_DIR/rollback.sh`:

```bash
#!/bin/bash
# rollback.sh — Restore pre-plugin state for optimize-my-resume
# Usage: bash .local-archive/pre-plugin-backup-YYYYMMDD/rollback.sh
set -e

BACKUP_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT="/Users/mkaplan/Documents/GitHub/optimize-my-resume"
MEMORY_DIR="$HOME/.claude/projects/-Users-mkaplan-Documents-GitHub-optimize-my-resume/memory"

echo "=== Rolling back plugin integration ==="

# 1. Restore project settings
echo "Restoring .claude/settings.json..."
cp "$BACKUP_DIR/claude-config/settings.json" "$PROJECT/.claude/settings.json"
cp "$BACKUP_DIR/claude-config/settings.local.json" "$PROJECT/.claude/settings.local.json"

# 2. Restore hooks (preserve existing, rollback just restores originals)
echo "Restoring .claude/hooks/..."
cp "$BACKUP_DIR/claude-hooks/"*.sh "$PROJECT/.claude/hooks/" 2>/dev/null || true

# 3. Restore knowledge workflows
echo "Restoring .agent/workflows/know-*.md and doc-session-summary.md..."
cp "$BACKUP_DIR/agent-workflows/"*.md "$PROJECT/.agent/workflows/"

# 4. Restore skills symlink
echo "Restoring .claude/skills symlink..."
rm -f "$PROJECT/.claude/skills"
SYMLINK_TARGET=$(cat "$BACKUP_DIR/skills-symlink-target.txt")
ln -s "$SYMLINK_TARGET" "$PROJECT/.claude/skills"

# 5. Restore memory
echo "Restoring MEMORY.md..."
cp "$BACKUP_DIR/memory/MEMORY.md" "$MEMORY_DIR/MEMORY.md"

# 6. Remove plugin artifacts
echo "Removing kg-config.json..."
rm -f "$HOME/.claude/kg-config.json"

echo ""
echo "=== Rollback complete ==="
echo "Manual steps remaining:"
echo "  1. Remove plugin entry from ~/.claude/settings.json if added"
echo "  2. Restart Claude Code to pick up changes"
```

Make executable: `chmod +x "$BACKUP_DIR/rollback.sh"`

---

### 4.5.3: Remove old knowledge-related components

**Remove 6 knowledge workflows that the plugin replaces:**
```bash
rm .agent/workflows/know-capture-lesson.md
rm .agent/workflows/know-recall.md
rm .agent/workflows/know-sync-all.md
rm .agent/workflows/know-update-graph.md
rm .agent/workflows/know-update-issue-plan.md
rm .agent/workflows/doc-session-summary.md
```

**Remove the skills symlink:**
```bash
rm .claude/skills
```

The symlink pointed `.claude/skills → ../.agent/workflows`, which made ALL project workflows (including `gov-*`, `plan-*`, `proj-*`) visible as Claude Code skills. After removal:
- `gov-*`, `plan-*`, `proj-*`, `doc-update`, `doc-handoff-backup` workflows remain in `.agent/workflows/` but are no longer discoverable as `/slash-commands`
- The plugin's 16 skills become the only `/knowledge:*` slash commands
- The remaining project workflows can still be invoked by the existing skill definitions in `~/.claude/skills/` (global level) which are separate

**IMPORTANT: Verify the remaining workflows still work** after removing the symlink. The global `~/.claude/skills/` directory has its own copies of `gov-*.md`, `plan-*.md`, `proj-*.md`, `doc-*.md` skills. Verify:
```bash
ls ~/.claude/skills/gov-*.md ~/.claude/skills/plan-*.md ~/.claude/skills/proj-*.md ~/.claude/skills/doc-*.md 2>/dev/null | wc -l
# Should show the governance/planning/project skills are still globally available
```

If global copies do NOT exist, the symlink removal would break those skills. In that case, re-create the symlink ONLY for the non-knowledge workflows:
```bash
# Fallback: copy remaining workflows to global skills
for f in gov-*.md plan-*.md proj-*.md doc-update.md doc-handoff-backup.md; do
  cp ".agent/workflows/$f" ~/.claude/skills/ 2>/dev/null
done
```

**DO NOT remove `.claude/hooks/`** — governance hooks (`validate-commit.sh`, `validate-branch.sh`, `trigger-shadow-sync.sh`) must remain. They enforce commit format and branch hierarchy, which are independent of the KG plugin.

---

### 4.5.4: Update project settings for plugin coexistence

**Read current `.claude/settings.json`**, then add the plugin's SessionStart hook while preserving existing PreToolUse/PostToolUse hooks.

Current hooks structure:
```json
{
  "hooks": {
    "PreToolUse": [...validate-commit, validate-branch...],
    "PostToolUse": [...trigger-shadow-sync...]
  }
}
```

Add SessionStart entry:
```json
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "/Users/mkaplan/Documents/GitHub/knowledge-graph-plugin/scripts/check-memory.sh",
            "timeout": 5
          }
        ]
      }
    ],
    "PreToolUse": [ ...existing unchanged... ],
    "PostToolUse": [ ...existing unchanged... ]
  }
}
```

---

### 4.5.5: Install plugin and initialize KG

**Step 1: Load plugin**
```bash
claude --plugin-dir /Users/mkaplan/Documents/GitHub/knowledge-graph-plugin
```
Verify: type `/knowledge:` — all 16 skills should appear.

**Step 2: Run `/knowledge:init`** — the real-world integration test

This is the **critical moment**. The init wizard must detect that `docs/` already exists.

Wizard responses:
1. **Name:** `optimize-my-resume`
2. **Path:** `/Users/mkaplan/Documents/GitHub/optimize-my-resume` (or `.`)
3. **Type:** `project-local`
4. **Categories:** `architecture`, `process`, `patterns`, `debugging`, `enforcement`, `knowledge-capture` (matching existing `docs/lessons-learned/` subdirectories)
5. **Git strategy:** `commit`

**Expected behavior at "docs/ already exists" prompt:**
- Init detects existing `docs/knowledge/`, `docs/lessons-learned/`, `docs/decisions/`, `docs/sessions/`
- Prompts: "docs/ already exists. Merge with existing structure? [y/N]"
- Answer: **y** — create only missing subdirectories, preserve existing files
- Init writes `~/.claude/kg-config.json` pointing to this project
- Sets as active KG

**Verify after init:**
```bash
cat ~/.claude/kg-config.json
# Should show: active = "optimize-my-resume", path = project root
```

**Step 3: Quick sanity checks**
```bash
/knowledge:status    # Should show file counts from existing docs/
/knowledge:list      # Should show "optimize-my-resume" as active
```

---

### 4.5.6: Update MEMORY.md for plugin skill names

The existing MEMORY.md references old skill names. Update the Workflow Skills table:

**Replace** (6 skills that moved to plugin):
| Old Name | New Name |
|----------|----------|
| `/know-capture-lesson` | `/knowledge:capture-lesson` |
| `/know-recall` | `/knowledge:recall` |
| `/know-update-graph` | `/knowledge:update-graph` |
| `/know-update-issue-plan` | `/knowledge:update-issue-plan` |
| `/know-sync-all` | `/knowledge:sync-all` |
| `/doc-session-summary` | `/knowledge:session-summary` |

**Add** (10 new plugin-only skills):
| Skill | Purpose |
|-------|---------|
| `/knowledge:init` | Create new knowledge graph with wizard |
| `/knowledge:list` | Display configured knowledge graphs |
| `/knowledge:switch` | Change active knowledge graph |
| `/knowledge:add-category` | Add category to active KG |
| `/knowledge:status` | Show KG info, stats, quick reference |
| `/knowledge:configure-sanitization` | Set up pre-commit hook for sensitive data |
| `/knowledge:check-sensitive` | Scan KG for sensitive information |
| `/knowledge:link-issue` | Link lesson to GitHub issue |
| `/knowledge:meta-issue` | Create meta-issue tracking structure |
| `/knowledge:extract-chat` | Extract chat history from Claude/Gemini logs |

**Add note** to MEMORY.md:
```
**Plugin**: Knowledge graph operations now provided by `knowledge-graph-plugin`
(loaded via --plugin-dir). Governance, planning, and project-specific skills
remain in .agent/workflows/ and are available via global ~/.claude/skills/.
```

**Update** the "Knowledge Graph ↔ Memory Synchronization" section to reference `/knowledge:update-graph` instead of `/know-update-graph`.

---

### 4.5.7: End-to-end integration verification (9 tests)

| # | Test | Command | Expected Result |
|---|------|---------|----------------|
| 1 | Recall existing content | `/knowledge:recall "Shadow Sync Protocol"` | Finds entries in docs/knowledge/patterns.md and docs/lessons-learned/ |
| 2 | Status shows existing content | `/knowledge:status` | Shows file counts: knowledge ~10, lessons ~40, decisions ~16, sessions ~30+ |
| 3 | Capture new lesson | `/knowledge:capture-lesson` | Creates file in docs/lessons-learned/ with git metadata frontmatter |
| 4 | Update knowledge graph | `/knowledge:update-graph` | Step 7 checks MEMORY.md for updates |
| 5 | Session summary | `/knowledge:session-summary` | Creates file in docs/sessions/ matching existing structure |
| 6 | Check sensitive data | `/knowledge:check-sensitive` | Scans existing KG, may find version numbers (expected for this project) |
| 7 | MCP search | `kg_search` via MCP | Finds content in existing docs/knowledge/ |
| 8 | Governance hooks still work | `git commit -m "test: invalid"` | validate-commit.sh blocks with exit code 2 |
| 9 | Chat extraction | `/knowledge:extract-chat -claude` | Python scripts run, output goes to chat-history/ |

---

### 4.5.8: Document results

**If all tests pass:**
1. Update `knowledge-graph-plugin/docs/plans/v9.5.0-phase-5-publish.md`: mark "Plugin works from standalone repo" → `[x]`
2. Note any init wizard behavior to feed back into plugin's `docs/SETUP.md`
3. If the "Integration with Existing Projects" section needs improvements, document what should change

**If tests FAIL:**
1. Run rollback: `bash .local-archive/pre-plugin-backup-YYYYMMDD/rollback.sh`
2. Document the failure
3. Fix the issue in the plugin repo at `/Users/mkaplan/Documents/GitHub/knowledge-graph-plugin/`
4. Re-attempt from step 4.5.4

---

## Rollback Quick Reference

```bash
bash /Users/mkaplan/Documents/GitHub/optimize-my-resume/.local-archive/pre-plugin-backup-YYYYMMDD/rollback.sh
```

**Restores:** settings.json, settings.local.json, 3 hooks, 6 workflows, skills symlink, MEMORY.md
**Removes:** kg-config.json
**Does NOT touch:** docs/ content, optimization-tools/, governance/planning/project skills, global ~/.claude/settings.json

---

## Critical Files Modified

| File | Action |
|------|--------|
| `optimize-my-resume/.agent/workflows/know-*.md` (5 files) | Remove |
| `optimize-my-resume/.agent/workflows/doc-session-summary.md` | Remove |
| `optimize-my-resume/.claude/skills` (symlink) | Remove |
| `optimize-my-resume/.claude/settings.json` | Add SessionStart hook |
| `~/.claude/projects/.../memory/MEMORY.md` | Update skill names |
| `~/.claude/kg-config.json` | Created by `/knowledge:init` |

---

## Documentation Gap Identified

The plugin's `docs/SETUP.md` (lines 77-94) has a brief "Integration with Existing Projects" section with two strategies but:
- No automated conflict detection beyond init's "docs/ exists" prompt
- No backup/rollback guidance
- No migration tooling for renaming skill references
- No guidance on hook coexistence with existing project hooks

**Feed back from this test:** After Phase 4.5 completes, update the plugin's SETUP.md with lessons learned. Consider adding `/knowledge:migrate` to ROADMAP.md as a future skill.

---

## Verification Checklist

- [ ] Backup archive created with all 11 files (~120K)
- [ ] rollback.sh created and executable
- [ ] 6 knowledge workflows removed from .agent/workflows/
- [ ] Skills symlink removed (and global skills verified working)
- [ ] .claude/settings.json updated with SessionStart hook (governance hooks preserved)
- [ ] Plugin loads: 16 skills visible in /knowledge: menu
- [ ] /knowledge:init completes with existing docs/ directory
- [ ] kg-config.json created with correct path
- [ ] All 9 integration tests pass
- [ ] MEMORY.md updated with new plugin skill names
- [ ] Governance hooks still enforce (validate-commit, validate-branch)
- [ ] No data loss in existing knowledge base
- [ ] Rollback script verified (dry-run or tested)

---

**Created:** 2026-02-13
**Depends on:** Phase 5.1-5.5 complete
**Blocks:** Phase 5.6 (standalone repo commit), Phase 5.7 (GitHub publishing)
