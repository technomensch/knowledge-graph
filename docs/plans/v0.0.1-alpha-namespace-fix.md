# Recommendation Plan: Configuration Alignment (Validated)

## Analysis Overview
The current configuration partially implements the recommendations from `gemini-troubleshooting.md`. Research confirms that Claude Code (v2.1+) uses namespacing as a primary safety mechanism. While "Namespace Elision" (hiding the prefix) is a convenience for unique commands, forcing a collision (the "Shadow Command" strategy) is a documented community workaround to regain consistent branding and categories.

## Research Validation
- **Namespace Requirement**: Confirmed as standard. Claude prefers prefixes for disambiguation.
- **Shadow Command Strategy**: Validated. Creating a tool named `list` creates a collision with the core `/list` command, forcing the CLI to show the `/knowledge:` prefix for all tools to ensure user intent is clear.
- **Metadata Schema (v2.2)**: The `ui.forceNamespace` flag is an emerging standard for 2026 builds, correctly placed in `.claude-plugin/plugin.json`.

## Identified Gaps & Alignment

### 1. Implementation Gap (Critical)
- **Status**: **FAILED**. 
- **Finding**: `mcp-server/src/index.ts` and `mcp-server/dist/index.js` do NOT register the `list` tool. 
- **Research Alignment**: Without registration at the *runtime* level, the collision is never detected by the CLI, rendering the `plugin.json` entry ineffective.

### 2. Branding Inconsistency
- **Status**: **MISALIGNED**. 
- **Finding**: `plugin.json` uses `"knowledge"`, but `index.ts` uses `"knowledge-graph"`.
- **Research Alignment**: For local marketplace plugins, internal registry consistency is key to avoiding "Distribution Mode" glitches.

### 3. Build Workflow Errors
- **Status**: **BROKEN**.
- **Finding**: Root `package.json` points to root `plugin.json` (missing). Source of truth is currently `.claude-plugin/plugin.json`.
- **Finding**: Duplicate `scripts` block in `mcp-server/package.json`.

## Validated Recommendation Plan

1. **[IMPLEMENT] Runtime Shadow Command**:
   - Add `server.tool("list", ...)` to `mcp-server/src/index.ts`. This is the single most important step to force namespacing.
   
2. **[ALIGN] Identity Sync**:
   - Change `new McpServer({ name: "knowledge-graph" })` to `name: "knowledge"` in `index.ts`.
   
3. **[REPAIR] Build Chain**:
   - Deduplicate `scripts` in `mcp-server/package.json`.
   - Update root `package.json` to use `.claude-plugin/plugin.json` as the source of truth for the `prepare-plugin` script.

4. **[VERIFY] Build Propagation**:
   - Execute `npm run prepare-plugin`.
   - Confirm `mcp-server/dist/index.js` contains the "list" tool string.
   - Run `/plugin list` to verify the namespace is visible in the UI.

> [!IMPORTANT]
> Because you are using a local marketplace for distribution mode, the `dist/index.js` MUST be rebuilt to trigger the collision logic.
